from pathlib import Path
import sys
from uuid import uuid4
from typing import List, Dict, Any

# Constants
HOME = Path.home()
PROJECTS_DIR = HOME / "projects" / "personal"
KITTY_SLEEP_TIME = 0.1
KITTY_RESIZE_INCREMENT = 5
KITTY_RESIZE_INCREMENT_LARGE = 10
KITTY_RESIZE_INCREMENT_XLARGE = 15

# Environment Variables
$PYTEST_ADDOPTS = "--pdbcls pudb.debugger:Debugger --capture=no"
$EDITOR = "nvim"
$VI_MODE = True
$DOCKER_BUILDKIT = 1
$BAT_THEME = "Nord"
$OLLAMA_API_BASE = "http://localhost:11434"
$OLLAMA_FAKE_API_KEY = "fake"
$PODMAN_COMPOSE_WARNING_LOGS = False

# Xonsh Configuration
__xonsh__.commands_cache.threadable_predictors["glances"] = lambda x: False

# Load Xontribs
xontrib load coreutils
xontrib load vox
xontrib load autovox


# Virtual Environment Policy
@events.autovox_policy
def vox_policy(path: Path, **_) -> Path | None:
    """Automatically activate virtual environments based on directory name."""
    venv = Path($VIRTUALENV_HOME, path.name)
    return venv if venv.exists() else None


# Kitty Helper Functions
def _kitty_cmd(action: str, **kwargs) -> None:
    """Execute kitty remote control commands."""
    args = []
    for key, value in kwargs.items():
        key = key.replace('_', '-')
        if isinstance(value, bool) and value:
            args.append(f"--{key}")
        elif value is not None:
            args.append(f"--{key} {value}")

    kitty @ @(action) @(args)

def _dashboard() -> None:
    """Launch comprehensive dashboard layout with monitoring tools."""
    commands = [
        ("launch", {"title": "sysmon", "type": "overlay"}, "btm"),
        ("launch", {"title": "term", "location": "vsplit"}, None),
        ("launch", {"title": "mail", "location": "hsplit"}, None),
        ("launch", {"type": "overlay"}, "neomutt"),
        ("resize-window", {"axis": "vertical", "increment": KITTY_RESIZE_INCREMENT}, None),
        ("focus-window", {"match": "title:term"}, None),
        ("launch", {"title": "calendar", "location": "vsplit"}, None),
        ("launch", {"type": "overlay"}, "ikhal"),
        ("focus-window", {"match": "title:sysmon"}, None),
        ("launch", {"title": "chat", "location": "hsplit"}, None),
        ("resize-window", {"axis": "vertical", "increment": KITTY_RESIZE_INCREMENT_LARGE}, None),
        ("focus-window", {"match": "title:sysmon"}, None),
        ("launch", {"title": "todo", "location": "vsplit"}, None),
        ("launch", {"type": "overlay"}, "todotxt-machine"),
        ("focus-window", {"match": "title:chat"}, None),
        ("launch", {"type": "overlay"}, "gurk"),
        ("focus-window", {"match": "title:mail"}, None),
    ]

    for action, kwargs, command in commands:
        cmd_args = []
        for key, value in kwargs.items():
            key = key.replace('_', '-')
            cmd_args.extend([f"--{key}", str(value)])

        if command:
            kitty @ @(action) @(cmd_args) @(command)
        else:
            kitty @ @(action) @(cmd_args)

# NNN File Manager Configuration
NNN_COLOURS = {
    "blk": "0B", "chr": "0B", "dir": "04", "exe": "06", "reg": "00",
    "hardlink": "06", "symlink": "06", "missing": "00", "orphan": "09",
    "fifo": "06", "sock": "0B", "other": "06"
}

NNN_PLUGINS = {"p": "preview-tui"}

NNN_BOOKMARKS = {
    "h": str(HOME),
    "d": str(HOME / "Downloads"),
}

$NNN_OPTS = "aei"
$NNN_BMS = "".join(f"{k}:{v};" for k, v in NNN_BOOKMARKS.items())
$NNN_PLUG = "".join(f"{k}:{v}" for k, v in NNN_PLUGINS.items())
$NNN_FCOLORS = "".join(NNN_COLOURS.values())
$SPLIT = "v"

# PATH Configuration
ADDITIONAL_PATHS = [
    f"{HOME}/AppImages/",
    f"{HOME}/.cargo/bin",
    f"{HOME}/.radicle/bin",
    f"{HOME}/.local/bin",
    "/home/linuxbrew/.linuxbrew/bin",
    "/home/linuxbrew/.linuxbrew/sbin",
]

$PATH = [p for p in ADDITIONAL_PATHS if p not in $PATH] + $PATH

# Powerline Prompt Configuration
$PL_COLORS = {
    "who": ("BLACK", "GREEN"),
    "venv": ("BLACK", "YELLOW"),
    "branch": ("BLACK"),
    "cwd": ("BLACK", "BLUE"),
    "git_root": ("BLACK", "RED"),
    "git_sub_dir": ("WHITE", "RED"),
    "short_cwd": ("WHITE", "#444"),
    "full_proc": ("WHITE", "RED", "#444"),
    "timing": ("WHITE", "#444"),
    "time": ("BLACK", "GREEN"),
    "history": ("BLACK", "BLUE"),
    "rtns": ("WHITE", "RED"),
    "full_rtns": ("WHITE", "RED", "#444"),
}
$PL_EXTRA_SEC = {'fix_for_tmux': int}
$PL_PROMPT = 'history'
$PL_RPROMPT = '!'
$PL_TOOLBAR = 'who>cwd>branch>virtualenv'


# Utility Functions
def replay_command(args: List[str]) -> int:
    """Replay command from history by index or show recent history."""
    if not args:
        history show -n
    else:
        @$(history @(args[0]))
    return 0

def _uuid() -> str:
    """Generate a random UUID string."""
    return str(uuid4())


# Aliases
GIT_ALIASES = {
    "gst": ["git", "status"],
    "gco": ["git", "checkout"],
    "gcm": ["git", "checkout", "main"],
    "glg": ["git", "log", "--oneline", "--graph", "--decorate"],
}

UTILITY_ALIASES = {
    "h": replay_command,
    "uuid": _uuid,
    "dashboard": _dashboard,
    "nvim.basic": ["nvim", "-u", "~/.config/nvim/basic.lua"],
    "open": ["xdg-open"],
    "rm": ["trash"],
    "xclip": ["xclip", "-selection", "-c"],
    "ssh": ["kitty", "+kitten", "ssh"],
    "bat": ["batcat"],
    "cat": ["batcat"],
    "gearlever": "flatpak run it.mijorus.gearlever",
}

aliases.update(GIT_ALIASES)
aliases.update(UTILITY_ALIASES)


# Development Layout Functions
def _add_second_terminal(directory: Path) -> None:
    """Add a second terminal split to the current layout."""
    kitty @ focus-window --match title:terminal
    kitty @ launch --location vsplit --cwd @(directory)

def _open_layout(directory: Path, with_extra_terminal: bool = True) -> None:
    """Open development layout with nvim and terminal splits."""
    kitty @ launch --title nvim --type overlay --copy-env --cwd @(directory) nvim
    kitty @ launch --title terminal --location hsplit --cwd @(directory)
    kitty @ focus-window --match title:nvim
    kitty @ resize-window --axis vertical --increment @(KITTY_RESIZE_INCREMENT_XLARGE)

    if with_extra_terminal:
        _add_second_terminal(directory)

    kitty @ focus-window --match title:nvim

def _dev(args: List[str]) -> None:
    """Open development layout in current or specified directory."""
    directory = Path.cwd() if not args else Path(args[0])
    _open_layout(directory)


def _dev_layout_i3(directory: Path | None = None) -> None:
    """Open development layout using i3 window manager (legacy function)."""
    directory = Path(directory) if directory else Path.cwd()

    if not directory.is_dir():
        raise ValueError(f"Directory does not exist: {directory}")

    commands = [
        "i3-msg split v",
        f"kitty -d {directory} &",
        f"sleep {KITTY_SLEEP_TIME}",
        "i3-msg resize set 100 ppt 75 ppt",
        f"sleep {KITTY_SLEEP_TIME}",
        "i3-msg split h",
        f"sleep {KITTY_SLEEP_TIME}",
        f"kitty -d {directory} &",
        f"sleep {KITTY_SLEEP_TIME}",
        "i3-msg focus right",
        f"kitty -d {directory} &",
    ]

    for cmd in commands:
        @(cmd.split())

# Project Management Functions
def _radicle(args: List[str]) -> int:
    """Manage Radicle containers (start/stop)."""
    compose_file = PROJECTS_DIR / "radicle-in-containers" / "compose.yaml"
    profiles = ["node", "explorer"]
    profile_args = [item for p in profiles for item in ("--profile", p)]
    actions = {
        "start": ["up", "--detach"],
        "stop": ["down"],
    }

    if args and args[0] in actions:
        docker compose -f @(compose_file) @(profile_args) @(actions[args[0]])
        return 0

    print("Usage: radicle <start|stop>")
    return 1

def _yazi_with_cd(args: List[str]) -> None:
    """Run yazi file manager and change to selected directory."""
    tmp = $(mktemp -t "yazi-cwd.XXXXXX")
    args.append(f"--cwd-file={tmp}")
    $[yazi @(args)]

    with open(tmp) as f:
        cwd = f.read().strip()

    if cwd and cwd != $PWD:
        cd @(cwd)

    rm -f -- @(tmp)

# Add remaining aliases
PROJECT_ALIASES = {
    "dev": _dev,
    "radicle": _radicle,
    "y": _yazi_with_cd,
}

aliases.update(PROJECT_ALIASES)

# External Tool Initialization
execx($(starship init xonsh))
execx($(zoxide init --cmd cd xonsh), 'exec', __xonsh__.ctx, filename='zoxide')

# Zoxide aliases (with safety checks for SSH compatibility)
if '__zoxide_z' in globals():
    builtins.aliases["z"] = __zoxide_z  # type: ignore  # pylint:disable=no-member
if '__zoxide_zi' in globals():
    builtins.aliases["zi"] = __zoxide_zi  # type: ignore  # pylint:disable=no-member
